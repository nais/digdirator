package crypto_test

import (
	"github.com/nais/digdirator/pkg/crypto"
	"github.com/stretchr/testify/assert"
	"testing"
)

const pemChainString = `
-----BEGIN CERTIFICATE-----
MIIE9zCCA9+gAwIBAgILD4KnGt7D5/a8FfYwDQYJKoZIhvcNAQELBQAwSzELMAkG
A1UEBhMCTk8xHTAbBgNVBAoMFEJ1eXBhc3MgQVMtOTgzMTYzMzI3MR0wGwYDVQQD
DBRCdXlwYXNzIENsYXNzIDMgQ0EgMzAeFw0xOTEyMTMxMjMzNTFaFw0yMjEyMTMy
MjU5MDBaMGwxCzAJBgNVBAYTAk5PMSMwIQYDVQQKDBpBUkJFSURTLSBPRyBWRUxG
RVJEU0VUQVRFTjEkMCIGA1UEAwwbTkFWIEludGVncmFzam9uIElkdGplbmVzdGVy
MRIwEAYDVQQFEwk4ODk2NDA3ODIwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEK
AoIBAQCggL/0NAdoINnPur9ULjlOmfkk3VUomfsOG5wTxO02pgwtQy3RclwecVcI
ze4H4l+w06YSiZOSTnLzWJ6u4SBknMjhRiDAsgsi7GZK8NRIk3kexbnOl8k+/J2w
hlBXCQlujC8xe+LmjRrC/VXyzajj9lFD0Occf6rf4XTFF0kZEQ24bom1jwp4TaYw
nfntg1l+51yu/Boi6rRBzYzJFUZYotJ1U4hNsAO5EPgHpjzngyxCvgNCa+RtZRQ8
zD/lSX61nGEurRYOG7gAgyn+MV39ucfzrYXG8OS0WTJMBmPLUMKXqXHq3SD5n60q
X1aO0dPtNqy4IwneONLBSCMprP2LAgMBAAGjggG5MIIBtTAJBgNVHRMEAjAAMB8G
A1UdIwQYMBaAFMzD+Ae3nG16TvWnKx0F+bNHHJHRMB0GA1UdDgQWBBRUqVJOJVQX
C2BtdkR0CxxTgco3uTAOBgNVHQ8BAf8EBAMCBLAwHQYDVR0lBBYwFAYIKwYBBQUH
AwIGCCsGAQUFBwMEMBUGA1UdIAQOMAwwCgYIYIRCARoBAwIwgaUGA1UdHwSBnTCB
mjAvoC2gK4YpaHR0cDovL2NybC5idXlwYXNzLm5vL2NybC9CUENsYXNzM0NBMy5j
cmwwZ6BloGOGYWxkYXA6Ly9sZGFwLmJ1eXBhc3Mubm8vZGM9QnV5cGFzcyxkYz1O
TyxDTj1CdXlwYXNzJTIwQ2xhc3MlMjAzJTIwQ0ElMjAzP2NlcnRpZmljYXRlUmV2
b2NhdGlvbkxpc3QwegYIKwYBBQUHAQEEbjBsMDMGCCsGAQUFBzABhidodHRwOi8v
b2NzcC5idXlwYXNzLm5vL29jc3AvQlBDbGFzczNDQTMwNQYIKwYBBQUHMAKGKWh0
dHA6Ly9jcnQuYnV5cGFzcy5uby9jcnQvQlBDbGFzczNDQTMuY2VyMA0GCSqGSIb3
DQEBCwUAA4IBAQCg1FT+llCs4uqdvZXxW1BCZu7euz9qDydI2ZFICea4HE/auYAa
00W8oyDEMJ+VWVuLuaspS/osyF8X4UWtd+9oPvs6xbHp5wnOLfCLmapw8wB41yPH
bubSCtHL1f0NcNOgafryasdrm07f6aGrYBFaS+uND6J9ME/dbMdPkwC1X8/AGxzi
KodyQ9gjF+Ps012XEJqbj0q9w4FKcl8E+bSf+WDi2RgxlsZNzGsn9yv87dq55LyU
4LLADTdgx6KN5jLKulcj1NicatEpDeEWD1TWPRxj0RWC3k6nWh2zHL2eNjc+yAAF
Lq4O2XZj0Wl50TSVRger5quosBKPoXxs461/
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIEyzCCArOgAwIBAgIBHjANBgkqhkiG9w0BAQsFADBOMQswCQYDVQQGEwJOTzEd
MBsGA1UECgwUQnV5cGFzcyBBUy05ODMxNjMzMjcxIDAeBgNVBAMMF0J1eXBhc3Mg
Q2xhc3MgMyBSb290IENBMB4XDTEyMDkyNTA4MDUxOVoXDTMyMDkyNTA4MDUxOVow
SzELMAkGA1UEBhMCTk8xHTAbBgNVBAoMFEJ1eXBhc3MgQVMtOTgzMTYzMzI3MR0w
GwYDVQQDDBRCdXlwYXNzIENsYXNzIDMgQ0EgMzCCASIwDQYJKoZIhvcNAQEBBQAD
ggEPADCCAQoCggEBAON6Gk4TsoAn39gyUXBUfjcLNaq1FLlq2mSqt7l4EUALQfwf
w//3jcKPb70rGYD1Mw46shRoL2gFJP3mD5FYe+5pAKqJ1VRdFb/qO/HnYPPBx2vz
bEJgOafCuBX6wEMJc0O8cTsv/MqLvW8K88S+ziZcTSXMo95XkYGcYyaQiS5PR1mz
ATTvA/Xm811oCI8jZD2ZjSQ8KhB8ePaRNJTiOK/xYhqSvU9Un7i83NDSAeliZYW6
asJ7g2DUcFWDytHvRJQtvd6tTxn+PUThC+IlgDJc6riJaIhYBqENID6LsBLdkSGI
KsxVDsjDOZ3568D1XaRH9Wlo6Hj0792Ncu7AqZUCAwEAAaOBtjCBszAPBgNVHRMB
Af8EBTADAQH/MB8GA1UdIwQYMBaAFEe4zf/lb+74suwvTg75JbCOPGvDMB0GA1Ud
DgQWBBTMw/gHt5xtek71pysdBfmzRxyR0TAOBgNVHQ8BAf8EBAMCAQYwEQYDVR0g
BAowCDAGBgRVHSAAMD0GA1UdHwQ2MDQwMqAwoC6GLGh0dHA6Ly9jcmwuYnV5cGFz
cy5uby9jcmwvQlBDbGFzczNSb290Q0EuY3JsMA0GCSqGSIb3DQEBCwUAA4ICAQAJ
EHvXHhjk5VKHDDvh5R3eaNjLNXwK9FQ65TIjkeciZcO53wHqumFBJX0fI7bYOthY
1RZQElyefhn9SQlNDiPYrGwfbv94A1RQq8WHFpafUHoGjgmorgHoCRm/JKAjuFvE
5NYc1EW2h8rAtg2apNRXe+TrTfLHH4gNYD6+Rd9L7zI6RQRgO11lmaWmC5C6VdBJ
fOtX/gCjpjOwhb9RXwKdGXlbCgpLlv5dhMcSjgxz7NJW3sjyWIhelt5vr7iK+3Xq
e1mTA869l8rb7eDXHpavH/fOQYlHNWDSJQBkA6nbPpYwTy0FWOEdSTrrsb0NLyiF
6snEzMyoMIfezj1yZJO+ATnZXeIsnrIRW5kL2BmHG0FJ7Up/zq89trNh8eYFE2wP
YKhAM3UZNT0jzLLpabJQEFCqoX3XEPYyAIYJzGbvnCYAPesy88MY9gZBVTCfNuyJ
r1qrFn2B+fCwwD1ZCOcg3FHr0K601z+v4KWB19T1ui81cNWdadchU3UxH3i5ZJIi
8z8abzj8E8l4sl5SD8iyUW58OF+bScx+P+RG2+DPw7uHbqItCYlpl/+YXhKCeGbZ
/mI4xHipWuuamnYzZcD1TJ2g+0J9aqLavrBrnhtR0tWS2gmds5G4yNxROB1uQLZP
Fswq7WjfCUK3A8RrnNGcGPaCOf4BAou0GAiGo8kWwg==
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIFWTCCA0GgAwIBAgIBAjANBgkqhkiG9w0BAQsFADBOMQswCQYDVQQGEwJOTzEd
MBsGA1UECgwUQnV5cGFzcyBBUy05ODMxNjMzMjcxIDAeBgNVBAMMF0J1eXBhc3Mg
Q2xhc3MgMyBSb290IENBMB4XDTEwMTAyNjA4Mjg1OFoXDTQwMTAyNjA4Mjg1OFow
TjELMAkGA1UEBhMCTk8xHTAbBgNVBAoMFEJ1eXBhc3MgQVMtOTgzMTYzMzI3MSAw
HgYDVQQDDBdCdXlwYXNzIENsYXNzIDMgUm9vdCBDQTCCAiIwDQYJKoZIhvcNAQEB
BQADggIPADCCAgoCggIBAKXaCpUWUOOV8l6ddjEGMnqb8RB2uACatVI2zSRHsJ8Y
ZLya9vrVediQYkwiL944PdbgqOkcLNt4EemOaFEVcsfzM4fkoF0LXOBXByow9c3E
N3coTRiR5r/VUv1xLXA+58bEiuPwKAv0dpihi4dVsjoT/Lc+JzeOIuOoTyrvYLs9
tznDDgFHmV0ST9tD+leh7fmdvhFHJlsTmKtdFoqwNxxXnUX/iJY2v7vKB3tvh2PX
0DJq1l1sDPGzbjniazEuOQAnFN44wOwZZoYS6J1yFhNkUsepNxz9gjDthBgd9K5c
/3ATAOux9TN6S9ZV+AWNS2mw9bMoNlwUxFFzTWsL8TQH2xc519woe2v1n/MuwU8X
KhDzzMro6/1rqy6any2CbgTUUgGTLT2G/H783+9CHaZr77kgxve9oKeV/afmiSTY
zIw0bOIjL9kSGiG5VZFvC5F5GQytQIgLcOJ60g7YaEi7ghM5EFjp2CoHxhLbWNvS
O1UQRwUVZ2J+GGOmRj8JDlQyXr8NYnon74Do29lLBlo3WiXQCBJ31G8JUJc9yB3D
34xFMFbG02SrZvPAXpacw8Tvw3xrizp5f7NJzz3iiZ+gMEuFuZyUJHmPfWupRWgP
K9Dx2hzLabjKSWJtyNBjYt1gD1iqj6G8BaVmos8bdrKEZLFMOVLAMLrwjEsCsLa3
AgMBAAGjQjBAMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFEe4zf/lb+74suwv
Tg75JbCOPGvDMA4GA1UdDwEB/wQEAwIBBjANBgkqhkiG9w0BAQsFAAOCAgEAACAj
QTUEkMJAYmDv4jVM1z+s4jSQuKFvdvoWFqRINyzpkMLyPPgKn9iB5btb2iUspKdV
cSQy9sgL8rxq+JOssgfCX5/bzMiKqr5qb+FJEMwx14C7u8jYog5kV+qi9cKpMRXS
IGrs/CIBKM+GuIAeqcwRpTzyFrNHnfzSgCHEy9BHcEGhyoMZCCxt8l13nIoUE9Q2
HJLw5QY33KbmkJs4j1xrG0aGQ0JfPgEHU1RdZX33inOhmlRaHylDFCfChQ+1iHsa
O5S3HWCntZznKWlXWpuTekMwGwPXYshApqr8ZORK15FTAaggiG6cX0S5y2CBNOxv
033aSF/rtJC8LakcC6wc1aJoIIAE1vyxjy+7SjENSoYc6+I2KSb12tjE8nVhz36u
dmNKekBlk4f4HoCMhuWG1o8O/FMsYOgWYRqiPkN7zTlgVGr18okmAWiDSKIz6MkE
kbIRNBE+6tBDGR8Dk5AM/1E9V/RBbuHLoL7ryWPNbczk+DaqaJ3tvV2XcEQNtg41
3OEMXbugUZTLfhbrES+jkkXITHHZvMmZUldGL1DPvTVp9D0VzgalLA8+9oG6lLvD
u79leNKGef9JOxqDDPDeeOzI8k1MGt6CKfjBWtrt7uYnXuhF0J0cUahoq0Tj0Itq
4/g7u9xN12TyUb7mqqta6THuBrxzvxNiCp/HuZc=
-----END CERTIFICATE-----
`

func TestConvertPEMBlockToX509Chain(t *testing.T) {
	certs, err := crypto.ConvertPEMBlockToX509Chain([]byte(pemChainString))
	assert.NoError(t, err)
	assert.Len(t, certs, 3)
	assert.Equal(t, "SERIALNUMBER=889640782,CN=NAV Integrasjon Idtjenester,O=ARBEIDS- OG VELFERDSETATEN,C=NO", certs[0].Subject.String())
	assert.Equal(t, "CN=Buypass Class 3 CA 3,O=Buypass AS-983163327,C=NO", certs[1].Subject.String())
	assert.Equal(t, "CN=Buypass Class 3 Root CA,O=Buypass AS-983163327,C=NO", certs[2].Subject.String())
}

func TestConvertX509CertificatesToX5c(t *testing.T) {
	certs, err := crypto.ConvertPEMBlockToX509Chain([]byte(pemChainString))
	assert.NoError(t, err)

	x5c := crypto.ConvertX509CertificatesToX5c(certs)
	assert.Len(t, x5c, 3)
	const certString = `MIIE9zCCA9+gAwIBAgILD4KnGt7D5/a8FfYwDQYJKoZIhvcNAQELBQAwSzELMAkGA1UEBhMCTk8xHTAbBgNVBAoMFEJ1eXBhc3MgQVMtOTgzMTYzMzI3MR0wGwYDVQQDDBRCdXlwYXNzIENsYXNzIDMgQ0EgMzAeFw0xOTEyMTMxMjMzNTFaFw0yMjEyMTMyMjU5MDBaMGwxCzAJBgNVBAYTAk5PMSMwIQYDVQQKDBpBUkJFSURTLSBPRyBWRUxGRVJEU0VUQVRFTjEkMCIGA1UEAwwbTkFWIEludGVncmFzam9uIElkdGplbmVzdGVyMRIwEAYDVQQFEwk4ODk2NDA3ODIwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCggL/0NAdoINnPur9ULjlOmfkk3VUomfsOG5wTxO02pgwtQy3RclwecVcIze4H4l+w06YSiZOSTnLzWJ6u4SBknMjhRiDAsgsi7GZK8NRIk3kexbnOl8k+/J2whlBXCQlujC8xe+LmjRrC/VXyzajj9lFD0Occf6rf4XTFF0kZEQ24bom1jwp4TaYwnfntg1l+51yu/Boi6rRBzYzJFUZYotJ1U4hNsAO5EPgHpjzngyxCvgNCa+RtZRQ8zD/lSX61nGEurRYOG7gAgyn+MV39ucfzrYXG8OS0WTJMBmPLUMKXqXHq3SD5n60qX1aO0dPtNqy4IwneONLBSCMprP2LAgMBAAGjggG5MIIBtTAJBgNVHRMEAjAAMB8GA1UdIwQYMBaAFMzD+Ae3nG16TvWnKx0F+bNHHJHRMB0GA1UdDgQWBBRUqVJOJVQXC2BtdkR0CxxTgco3uTAOBgNVHQ8BAf8EBAMCBLAwHQYDVR0lBBYwFAYIKwYBBQUHAwIGCCsGAQUFBwMEMBUGA1UdIAQOMAwwCgYIYIRCARoBAwIwgaUGA1UdHwSBnTCBmjAvoC2gK4YpaHR0cDovL2NybC5idXlwYXNzLm5vL2NybC9CUENsYXNzM0NBMy5jcmwwZ6BloGOGYWxkYXA6Ly9sZGFwLmJ1eXBhc3Mubm8vZGM9QnV5cGFzcyxkYz1OTyxDTj1CdXlwYXNzJTIwQ2xhc3MlMjAzJTIwQ0ElMjAzP2NlcnRpZmljYXRlUmV2b2NhdGlvbkxpc3QwegYIKwYBBQUHAQEEbjBsMDMGCCsGAQUFBzABhidodHRwOi8vb2NzcC5idXlwYXNzLm5vL29jc3AvQlBDbGFzczNDQTMwNQYIKwYBBQUHMAKGKWh0dHA6Ly9jcnQuYnV5cGFzcy5uby9jcnQvQlBDbGFzczNDQTMuY2VyMA0GCSqGSIb3DQEBCwUAA4IBAQCg1FT+llCs4uqdvZXxW1BCZu7euz9qDydI2ZFICea4HE/auYAa00W8oyDEMJ+VWVuLuaspS/osyF8X4UWtd+9oPvs6xbHp5wnOLfCLmapw8wB41yPHbubSCtHL1f0NcNOgafryasdrm07f6aGrYBFaS+uND6J9ME/dbMdPkwC1X8/AGxziKodyQ9gjF+Ps012XEJqbj0q9w4FKcl8E+bSf+WDi2RgxlsZNzGsn9yv87dq55LyU4LLADTdgx6KN5jLKulcj1NicatEpDeEWD1TWPRxj0RWC3k6nWh2zHL2eNjc+yAAFLq4O2XZj0Wl50TSVRger5quosBKPoXxs461/`
	assert.Equal(t, certString, x5c[0])
	assert.NotEqual(t, certString, x5c[1])
}
